<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Accueil</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.14.2/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="https://code.jquery.com/ui/1.14.2/jquery-ui.js"></script>
    <script src="script.js"></script>
    <script src="audio-player.js"></script>
    <script src="node-auth/js/app.js"></script>
    <script src="header-ui.js" defer></script>
    <!-- Pop-up Exit Intent - √Ä ins√©rer n'importe o√π dans votre page -->
<style>
    .exit-popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .exit-popup-overlay.show {
        display: flex;
        opacity: 1;
    }

    .exit-popup-overlay.fade-out {
        opacity: 0;
    }

    .exit-popup {
        background: white;
        padding: 40px 45px;
        border-radius: 16px;
        box-shadow: 0 15px 50px rgba(0, 0, 0, 0.25);
        text-align: center;
        max-width: 520px;
        width: 92%;
        transform: scale(0.9);
        transition: transform 0.3s ease;
        position: relative;
    }

    /* Tracks dans la popup */
    .exit-popup-tracks {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 22px;
        max-height: 300px;
        overflow-y: auto;
    }

    .exit-popup-tracks .track-card {
        display: flex;
        align-items: center;
        gap: 14px;
        background: linear-gradient(135deg, #fefefe 0%, #f7f7f7 100%);
        border: 1px solid #e8e8e8;
        padding: 12px 16px;
        border-radius: 12px;
        text-align: left;
        cursor: pointer;
        transition: all 0.25s ease;
        position: relative;
        width: 100%;
        box-sizing: border-box;
    }

    .exit-popup-tracks .track-card:hover {
        background: linear-gradient(135deg, #fff8f0 0%, #fff3e6 100%);
        border-color: #ed7a26;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(237, 122, 38, 0.15);
    }

    .exit-popup-tracks .track-card.playing {
        background: linear-gradient(135deg, #fff8f0 0%, #fff3e6 100%);
        border-left: 4px solid #ed7a26;
    }

    .exit-popup-tracks .track-cover {
        width: 58px;
        height: 58px;
        border-radius: 10px;
        object-fit: cover;
        flex-shrink: 0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .exit-popup-tracks .track-info {
        display: flex;
        flex-direction: column;
        justify-content: center;
        flex: 1;
        min-width: 0;
    }

    .exit-popup-tracks .track-info h3 {
        font-size: 0.95rem;
        margin: 0 0 3px 0;
        color: #2c3e50;
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .exit-popup-tracks .track-info p {
        font-size: 0.8rem;
        margin: 0;
        color: #95a5a6;
    }

    .exit-popup-tracks .track-actions {
        display: flex;
        align-items: center;
        gap: 6px;
        flex-shrink: 0;
    }

    .exit-popup-tracks .popup-play-icon {
        width: 28px;
        height: 28px;
        flex-shrink: 0;
        fill: #ed7a26;
        opacity: 0.5;
        transition: opacity 0.2s ease;
    }

    .exit-popup-tracks .track-card:hover .popup-play-icon {
        opacity: 1;
    }

    /* Bouton ajouter √† une playlist */
    .exit-popup-tracks .popup-add-playlist-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 2px solid #ddd;
        background: white;
        color: #999;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        flex-shrink: 0;
        line-height: 1;
        padding: 0;
    }

    .exit-popup-tracks .popup-add-playlist-btn:hover {
        border-color: #ed7a26;
        color: #ed7a26;
        background: #fff8f0;
        transform: scale(1.1);
    }

    .exit-popup-tracks .popup-add-playlist-btn.added {
        border-color: #27ae60;
        color: #27ae60;
        background: #eafaf1;
    }

    /* Dropdown playlist dans la popup */
    .popup-playlist-dropdown {
        position: fixed;
        background: white;
        border-radius: 10px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.2);
        z-index: 10001;
        min-width: 220px;
        max-height: 200px;
        overflow-y: auto;
        padding: 6px 0;
        display: none;
    }

    .popup-playlist-dropdown.visible {
        display: block;
    }

    .popup-playlist-dropdown .pdd-title {
        font-size: 11px;
        font-weight: 600;
        color: #95a5a6;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 8px 14px 4px;
        margin: 0;
    }

    .popup-playlist-dropdown .pdd-item {
        padding: 9px 14px;
        cursor: pointer;
        font-size: 13px;
        color: #2c3e50;
        transition: background 0.15s;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .popup-playlist-dropdown .pdd-item:hover {
        background: #fff3e6;
        color: #ed7a26;
    }

    .popup-playlist-dropdown .pdd-item .pdd-icon {
        font-size: 14px;
    }

    .popup-playlist-dropdown .pdd-empty {
        padding: 12px 14px;
        font-size: 12px;
        color: #bdc3c7;
        text-align: center;
    }

    .popup-playlist-dropdown .pdd-login {
        padding: 12px 14px;
        font-size: 12px;
        color: #ed7a26;
        text-align: center;
    }

    .popup-playlist-dropdown .pdd-login a {
        color: #ed7a26;
        font-weight: 600;
        text-decoration: none;
    }

    .popup-playlist-dropdown .pdd-login a:hover {
        text-decoration: underline;
    }

    .exit-popup .popup-emoji {
        font-size: 36px;
        margin-bottom: 8px;
        display: block;
    }

    /* Animation notification popup */
    @keyframes popupNotifIn {
        0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
        15% { opacity: 1; transform: translateX(-50%) translateY(0); }
        85% { opacity: 1; transform: translateX(-50%) translateY(0); }
        100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
    }

    /* Animation de suppression d'une track card */
    @keyframes popupCardFadeOut {
        0% { opacity: 1; max-height: 90px; margin-bottom: 8px; padding: 12px 16px; }
        100% { opacity: 0; max-height: 0; margin-bottom: 0; padding: 0 16px; overflow: hidden; }
    }

    @keyframes popupCardFadeIn {
        0% { opacity: 0; transform: translateY(15px); }
        100% { opacity: 1; transform: translateY(0); }
    }

    /* Quick create playlist form dans le dropdown */
    .pdd-quick-create {
        padding: 10px 14px;
        border-top: 1px solid #f0f0f0;
    }

    .pdd-quick-create input {
        width: 100%;
        padding: 7px 10px;
        border: 1.5px solid #ddd;
        border-radius: 6px;
        font-size: 12px;
        font-family: 'Outfit', sans-serif;
        outline: none;
        transition: border-color 0.2s;
        box-sizing: border-box;
        margin-bottom: 6px;
    }

    .pdd-quick-create input:focus {
        border-color: #ed7a26;
    }

    .pdd-quick-create button {
        width: 100%;
        padding: 7px;
        background: #ed7a26;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        font-family: 'Outfit', sans-serif;
        cursor: pointer;
        transition: background 0.2s;
    }

    .pdd-quick-create button:hover {
        background: #d36a1a;
    }

    .pdd-quick-create button:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .exit-popup-overlay.show .exit-popup {
        transform: scale(1);
    }

    .exit-popup.scale-out {
        transform: scale(0.9);
    }

    .exit-popup h1 {
        color: #2c3e50;
        margin: 0 0 10px 0;
        font-size: 22px;
        font-weight: 600;
        line-height: 1.4;
        font-family: 'Outfit', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    .exit-popup-subtitle {
        color: #7f8c8d;
        font-size: 14px;
        margin-bottom: 20px;
        font-weight: 400;
        font-family: 'Outfit', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    .exit-popup-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
    }

    .exit-popup-btn {
        padding: 12px 28px;
        font-size: 14px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 500;
        font-family: 'Outfit', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    .exit-popup-btn-explore {
        background: #ed7a26;
        color: white;
    }

    .exit-popup-btn-explore:hover {
        background: #d36a1a;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(237, 122, 38, 0.35);
    }

    .exit-popup-btn-stop {
        background: #ecf0f1;
        color: #7f8c8d;
        display: none;
    }

    .exit-popup-btn-stop.visible {
        display: inline-block;
    }

    .exit-popup-btn-stop:hover {
        background: #d5dbdb;
        color: #5a6c7d;
    }

    .exit-popup-btn-close {
        background: transparent;
        color: #bdc3c7;
        font-size: 13px;
        padding: 8px 20px;
    }

    .exit-popup-btn-close:hover {
        color: #7f8c8d;
    }

    .exit-popup-message {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 36px;
        font-weight: 600;
        color: #e74c3c;
        z-index: 10000;
        opacity: 0;
        animation: exitPopupFadeInOut 3s ease-in-out;
        pointer-events: none;
        background: white;
        padding: 30px 50px;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    @keyframes exitPopupFadeInOut {
        0% {
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.8);
        }
        15% {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        85% {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        100% {
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.8);
        }
    }

    .exit-popup-confetti {
        position: fixed;
        width: 10px;
        height: 10px;
        position: absolute;
        animation: exitPopupConfettiFall 3s linear forwards;
        z-index: 9998;
    }

    @keyframes exitPopupConfettiFall {
        to {
            transform: translateY(100vh) rotate(360deg);
            opacity: 0;
        }
    }
</style>
</head>
<body class="accueil">
    <header>
        <a href="accueil.html"><h2>MuSE</h2></a> 
        <nav>
            <a href="accueil.html">Accueil</a>
            <a href="playlists.html">Playlists</a>
            <a href="preferences.html">Pr√©f√©rences</a>
                
            <div class="dropdown">
                <a href="#">API ‚ñæ</a>
                <div class="dropdown-content">
                    <a href="api-installation.html">Installation</a>
                    <a href="api-documentation.html">Documentation</a>
                    <a href="api-test.html">Testez l'API</a>
                </div>
            </div>
        </nav>

        <div class="header-right">
    
        <div id="auth-buttons" class="connexion-inscription">
            <a href="connexion.html?mode=login">Connexion</a>
            <button>
                <a href="connexion.html?mode=register">Inscription</a>
            </button>
        </div>

        <div id="user-menu" class="user-dropdown hidden">
            <a href="#" id="user-name-display">Mon Profil ‚ñæ</a>
            
            <div class="dropdown-content user-dropdown-content">
                <a href="profil.html">Mon profil</a>
                <a href="#" id="logoutBtn" class="logout-link">D√©connexion</a>
            </div>
        </div>

    </div>
    </header>

    <main>
        <section class="hero">

    <!-- Barres equalizer (inject√©es par JS) -->
    <div class="equalizer-bg" id="equalizer-bg"></div>

    <!-- Contenu -->
    <h1>D√©couvre, Ressens, Partage</h1>
    <h2>MuSE te connecte aux albums, artistes et playlists qui te correspondent. Explore une nouvelle fa√ßon d'√©couter la musique.</h2>
    <div class="btns">
        <a href="connexion.html" class="btn-login">Connexion</a>
        <a href="connexion.html" class="btn-signup">Inscription</a>
    </div>

</section>
        <section class="albums">
            <h2>S√©lection d'albums</h2>
            <div id="albums-container"></div>
        </section>
        <section class="tracks">
            <h2>Musiques que vous pourriez aimer</h2>
            <div id="tracks-container"></div>
        </section>
        <section class="artists">
            <h2>Artistes qui pourraient vous plaire</h2>
            <div id="artists-container"></div>
        </section>
        <div class="exit-popup-overlay" id="exitPopupOverlay">
            <div class="exit-popup" id="exitPopup">
                <span class="popup-emoji">üéß</span>
                <h1>Avant de partir, √©coutez √ßa !</h1>
                <p class="exit-popup-subtitle">Ces morceaux pourraient vous plaire ‚Äî cliquez pour √©couter un extrait</p>
                <div class="exit-popup-tracks" id="popup-tracks-container"></div>
                <div class="exit-popup-buttons">
                    <button class="exit-popup-btn exit-popup-btn-stop" id="popupStopBtn" onclick="exitPopupStopMusic()">‚èπ Arr√™ter la musique</button>
                    <button class="exit-popup-btn exit-popup-btn-explore" onclick="exitPopupExplore()">üé∂ Explorer plus de musiques</button>
                    <button class="exit-popup-btn exit-popup-btn-close" onclick="exitPopupDismiss()">Non merci</button>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="titre-footer">
            <h2>MuSE</h2>
        </div>
        <div class="navigation-footer">
            <div>
                <p>Soci√©t√©</p>
                <div>
                    <a href="#">√Ä propos de nous</a>
                    <a href="#">Offre d'emploi</a>
                </div>
            </div>
            <div>
                <p>Liens utiles</p>
                <div>
                    <a href="contact.html">Nous contacter</a>
                </div>
            </div>
            <div>
                <p>Communaut√©</p>
                <div>
                    <a href="#">D√©veloppeurs</a>
                </div>
            </div>
            <div>
                <p>L√©gal</p>
                <div>
                    <a href="#">Mentions l√©gales</a>
                </div>
            </div>
        </div>
        <div class="barre-separation-footer"></div>
        <div class="fin-footer">
            <div class="reseaux-sociaux-footer">
                <a href="#"><img src="/images/icones/instagram.avif" alt="Instagram"/></a>
                <a href="#"><img src="/images/icones/linkedin.avif" alt="LinkedIn"/></a>
                <a href="#"><img src="/images/icones/github.avif" alt="GitHub"/></a>
                <a href="#"><img src="/images/icones/facebook.avif" alt="Facebook"/></a>
            </div>
            <p>¬© 2026 MuSE Fran√ßais</p>
        </div>
    </footer>

    
    <script>
        (function() {
            const container = document.getElementById('equalizer-bg');
            const BAR_COUNT = 60;

            for (let i = 0; i < BAR_COUNT; i++) {
                const bar = document.createElement('div');
                bar.classList.add('eq-bar');

                const hMin     = Math.floor(Math.random() * 60)  + 15;   // 15‚Äì75 px
                const hMax     = Math.floor(Math.random() * 220) + 80;   // 80‚Äì300 px
                const duration = (Math.random() * 1.2 + 0.4).toFixed(2); // 0.4‚Äì1.6 s
                const delay    = (Math.random() * 2.0).toFixed(2);       // 0‚Äì2 s

                bar.style.setProperty('--h-min', hMin + 'px');
                bar.style.setProperty('--h-max', hMax + 'px');
                bar.style.setProperty('--duration', duration + 's');
                bar.style.animationDelay = `-${delay}s`;
                bar.style.height = hMin + 'px';

                container.appendChild(bar);
            }
        })();

        (function() {
            let exitPopupShown = false;
            // Pool de toutes les recommandations charg√©es (tracks compl√®tes)
            let popupRecoPool = [];
            // IDs des tracks d√©j√† affich√©es ou ajout√©es (pour ne pas les re-proposer)
            let popupDisplayedIds = new Set();
            const POPUP_VISIBLE_COUNT = 3;

            // D√©tection de la souris qui sort de la fen√™tre
            document.addEventListener('mouseout', function(e) {
                if (!exitPopupShown && e.clientY <= 0) {
                    exitPopupShow();
                }
            });

            // Fermeture en cliquant sur l'overlay
            document.getElementById('exitPopupOverlay').addEventListener('click', function(e) {
                if (e.target === this) {
                    exitPopupClose();
                }
            });

            // Cr√©er un √©l√©ment track-card √† partir d'un objet track
            function createPopupTrackCard(track) {
                let filename = null;
                if (track.track_image_file) {
                    const match = track.track_image_file.match(/([^/]+\.(jpg|png|jpeg))$/i);
                    filename = match ? match[1] : track.track_image_file;
                }
                let imageUrl = "images/no_image_music.png";
                if (filename) {
                    imageUrl = "https://freemusicarchive.org/image/?file=images%2Falbums%2F" + filename + "&width=290&height=290&type=album";
                }
                const trackCard = document.createElement("div");
                trackCard.classList.add("track-card");
                trackCard.dataset.trackId = track.track_id;
                trackCard.innerHTML = `
                    <img src="${imageUrl}" alt="${track.track_title}" class="track-cover" onerror="this.src='images/no_image_music.png'">
                    <div class="track-info">
                        <h3>${track.track_title}</h3>
                        <p>${track.artist_names?.split(",")[0] || "Artiste inconnu"}</p>
                    </div>
                    <div class="track-actions">
                        <svg class="popup-play-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                        <button class="popup-add-playlist-btn" title="Ajouter √† une playlist" data-track-id="${track.track_id}">+</button>
                    </div>
                `;
                // Clic sur la carte = lecture
                trackCard.addEventListener('click', function(e) {
                    if (e.target.closest('.popup-add-playlist-btn')) return;
                    document.getElementById('popupStopBtn').classList.add('visible');
                });
                // Clic sur le "+" = ouvrir le s√©lecteur de playlist
                trackCard.querySelector('.popup-add-playlist-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    popupShowPlaylistPicker(track.track_id, this);
                });
                return trackCard;
            }

            // Prendre la prochaine track disponible dans le pool
            function getNextRecoTrack() {
                for (const track of popupRecoPool) {
                    if (!popupDisplayedIds.has(track.track_id)) {
                        popupDisplayedIds.add(track.track_id);
                        return track;
                    }
                }
                return null;
            }

            // Retirer une track card avec animation et en ajouter une nouvelle
            function popupRemoveAndReplace(trackId) {
                const container = document.getElementById('popup-tracks-container');
                const card = container.querySelector(`.track-card[data-track-id="${trackId}"]`);
                if (!card) return;

                // Animer la suppression
                card.style.animation = 'popupCardFadeOut 0.4s ease forwards';
                setTimeout(() => {
                    card.remove();

                    // Ajouter une nouvelle track depuis le pool
                    const nextTrack = getNextRecoTrack();
                    if (nextTrack) {
                        const newCard = createPopupTrackCard(nextTrack);
                        newCard.style.animation = 'popupCardFadeIn 0.4s ease';
                        container.appendChild(newCard);

                        // Scroller doucement vers le bas pour montrer la nouvelle
                        setTimeout(() => {
                            container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
                        }, 100);
                    }
                }, 400);
            }

            function exitPopupShow() {
                const overlay = document.getElementById('exitPopupOverlay');
                overlay.classList.add('show');
                exitPopupShown = true;

                const popupContainer = document.getElementById('popup-tracks-container');
                if (popupContainer && popupContainer.children.length === 0) {
                    // Construire l'URL de recommandation selon les pr√©f√©rences utilisateur
                    const popupUserId = localStorage.getItem("userId");
                    let recoUrlPromise;

                    if (popupUserId) {
                        recoUrlPromise = fetch(`http://127.0.0.1:8000/voir_favorite/${popupUserId}`)
                            .then(res => res.json())
                            .then(prefData => {
                                let trackIds = [];
                                if (prefData.count > 0 && prefData.results[0].ids_tracks) {
                                    trackIds = prefData.results[0].ids_tracks.split(',').filter(x => x);
                                }
                                if (trackIds.length === 0) trackIds = ['81466'];
                                return `http://127.0.0.1:8000/reco/tracks?${trackIds.map(id => 'track_ids=' + id).join('&')}&limit=15`;
                            })
                            .catch(() => 'http://127.0.0.1:8000/reco/tracks?track_ids=81466&limit=15');
                    } else {
                        recoUrlPromise = Promise.resolve('http://127.0.0.1:8000/reco/tracks?track_ids=81466&limit=15');
                    }

                    recoUrlPromise.then(recoUrl => {
                        fetch(recoUrl)
                            .then(response => response.json())
                            .then(async data => {
                                const trackIds = data.results.map(t => t.track_id);
                                const trackRequests = trackIds.map(id =>
                                    fetch(`http://127.0.0.1:8000/tracks/${id}`)
                                        .then(res => res.json())
                                        .catch(() => null)
                                );
                                const allTracks = (await Promise.all(trackRequests)).filter(t => t !== null);
                                popupRecoPool = allTracks;

                                const initialTracks = allTracks.slice(0, POPUP_VISIBLE_COUNT);
                                initialTracks.forEach(track => {
                                    popupDisplayedIds.add(track.track_id);
                                    const card = createPopupTrackCard(track);
                                    popupContainer.appendChild(card);
                                });
                            })
                            .catch(err => console.error("Erreur chargement tracks popup:", err));
                    });
                }
            }

            function exitPopupClose() {
                const popup = document.getElementById('exitPopup');
                const overlay = document.getElementById('exitPopupOverlay');
                
                popup.classList.add('scale-out');
                overlay.classList.add('fade-out');
                
                setTimeout(() => {
                    overlay.classList.remove('show', 'fade-out');
                    popup.classList.remove('scale-out');
                }, 300);
            }

            // Arr√™ter la musique depuis la popup
            window.exitPopupStopMusic = function() {
                if (typeof audioPlayer !== 'undefined') {
                    audioPlayer.stop();
                }
                // Retirer le style playing des track-cards de la popup
                document.querySelectorAll('#popup-tracks-container .track-card').forEach(card => {
                    card.classList.remove('playing');
                });
                document.getElementById('popupStopBtn').classList.remove('visible');
            }

            // Explorer plus de musiques = fermer la popup, l'utilisateur reste sur le site
            window.exitPopupExplore = function() {
                exitPopupClose();
                // Scroller vers la section tracks du site
                const tracksSection = document.querySelector('.tracks');
                if (tracksSection) {
                    setTimeout(() => {
                        tracksSection.scrollIntoView({ behavior: 'smooth' });
                    }, 350);
                }
            }

            // Fermer sans rien faire
            window.exitPopupDismiss = function() {
                if (typeof audioPlayer !== 'undefined') {
                    audioPlayer.stop();
                }
                exitPopupClose();
            }

            // ====== AJOUT √Ä UNE PLAYLIST ======

            // Cr√©er le dropdown une seule fois
            const playlistDropdown = document.createElement('div');
            playlistDropdown.className = 'popup-playlist-dropdown';
            playlistDropdown.id = 'popupPlaylistDropdown';
            document.body.appendChild(playlistDropdown);

            // Fermer le dropdown si on clique ailleurs
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.popup-playlist-dropdown') && !e.target.closest('.popup-add-playlist-btn') && !e.target.closest('.pdd-quick-create')) {
                    playlistDropdown.classList.remove('visible');
                }
            });

            // Afficher le s√©lecteur de playlist
            async function popupShowPlaylistPicker(trackId, btnElement) {
                const dd = document.getElementById('popupPlaylistDropdown');

                // Positionner le dropdown pr√®s du bouton
                const rect = btnElement.getBoundingClientRect();
                dd.style.top = (rect.bottom + 5) + 'px';
                dd.style.left = Math.max(10, rect.left - 180) + 'px';

                dd.innerHTML = '<p class="pdd-title">Chargement...</p>';
                dd.classList.add('visible');

                try {
                    // R√©cup√©rer l'userId via le dashboard
                    const authRes = await fetch('http://localhost:3000/dashboard', { credentials: 'include' });
                    const authData = await authRes.json();

                    if (authData.error) {
                        dd.innerHTML = '<div class="pdd-login"><a href="connexion.html">Connectez-vous</a> pour ajouter √† une playlist</div>';
                        return;
                    }

                    const userId = authData.user.user_id || 1;

                    // R√©cup√©rer les playlists de l'utilisateur
                    const plRes = await fetch(`http://127.0.0.1:8000/users/${userId}/playlists`);
                    const playlists = await plRes.json();

                    if (!playlists || playlists.length === 0) {
                        // Connect√© mais aucune playlist ‚Üí proposer de cr√©er rapidement
                        dd.innerHTML = `
                            <p class="pdd-title">Aucune playlist</p>
                            <div class="pdd-quick-create">
                                <input type="text" id="pddQuickName" placeholder="Nom de la playlist" maxlength="50">
                                <button id="pddQuickCreateBtn" onclick="popupQuickCreatePlaylist(${userId}, ${trackId})">‚ú® Cr√©er et ajouter</button>
                            </div>
                        `;
                        // Focus auto sur l'input
                        setTimeout(() => {
                            const inp = document.getElementById('pddQuickName');
                            if (inp) inp.focus();
                        }, 100);
                        return;
                    }

                    let html = '<p class="pdd-title">Ajouter √†...</p>';
                    playlists.forEach(pl => {
                        html += `<div class="pdd-item" data-playlist-id="${pl.playlist_id}" data-track-id="${trackId}">
                            <span class="pdd-icon">üéµ</span>${escapeHtmlPopup(pl.playlist_name)}
                        </div>`;
                    });
                    // Toujours proposer de cr√©er une nouvelle playlist en bas
                    html += `<div style="border-top:1px solid #f0f0f0; margin-top:4px; padding-top:4px;"></div>`;
                    html += `<div class="pdd-item pdd-new-playlist" data-track-id="${trackId}" data-user-id="${userId}" style="color:#ed7a26;font-weight:500;">
                        <span class="pdd-icon">‚ûï</span> Nouvelle playlist
                    </div>`;
                    dd.innerHTML = html;

                    // Event listeners sur chaque playlist item
                    dd.querySelectorAll('.pdd-item:not(.pdd-new-playlist)').forEach(item => {
                        item.addEventListener('click', async function() {
                            const plId = this.dataset.playlistId;
                            const tId = this.dataset.trackId;
                            await popupAddTrackToPlaylist(plId, tId, btnElement);
                            dd.classList.remove('visible');
                        });
                    });

                    // Event listener "Nouvelle playlist"
                    const newPlBtn = dd.querySelector('.pdd-new-playlist');
                    if (newPlBtn) {
                        newPlBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const tId = this.dataset.trackId;
                            const uId = this.dataset.userId;
                            dd.innerHTML = `
                                <p class="pdd-title">Nouvelle playlist</p>
                                <div class="pdd-quick-create">
                                    <input type="text" id="pddQuickName" placeholder="Nom de la playlist" maxlength="50">
                                    <button id="pddQuickCreateBtn" onclick="popupQuickCreatePlaylist(${uId}, ${tId})">‚ú® Cr√©er et ajouter</button>
                                </div>
                            `;
                            setTimeout(() => {
                                const inp = document.getElementById('pddQuickName');
                                if (inp) inp.focus();
                            }, 100);
                        });
                    }

                } catch (err) {
                    console.error('Erreur chargement playlists:', err);
                    dd.innerHTML = '<div class="pdd-empty">Erreur de chargement</div>';
                }
            }

            // Ajouter une track √† une playlist existante
            async function popupAddTrackToPlaylist(playlistId, trackId, btnElement) {
                try {
                    // 1. R√©cup√©rer les tracks actuelles de la playlist
                    const getRes = await fetch(`http://127.0.0.1:8000/playlists/${playlistId}`);
                    const playlist = await getRes.json();

                    const existingIds = (playlist.tracks || []).map(t => t.track_id);

                    // V√©rifier si d√©j√† pr√©sent
                    if (existingIds.includes(parseInt(trackId))) {
                        popupShowNotif('D√©j√† dans cette playlist', 'info');
                        return;
                    }

                    // 2. Ajouter la nouvelle track
                    existingIds.push(parseInt(trackId));

                    const postRes = await fetch(`http://127.0.0.1:8000/playlists/${playlistId}/tracks`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ track_ids: existingIds })
                    });

                    if (postRes.ok) {
                        popupShowNotif('‚úÖ Ajout√© √† ¬´ ' + (playlist.playlist_name || 'la playlist') + ' ¬ª !', 'success');
                        // Retirer la carte et la remplacer par une nouvelle suggestion
                        popupRemoveAndReplace(parseInt(trackId));
                    } else {
                        popupShowNotif('Erreur lors de l\'ajout', 'error');
                    }
                } catch (err) {
                    console.error('Erreur ajout playlist:', err);
                    popupShowNotif('Erreur lors de l\'ajout', 'error');
                }
            }

            // Cr√©er rapidement une playlist et y ajouter la track
            window.popupQuickCreatePlaylist = async function(userId, trackId) {
                const nameInput = document.getElementById('pddQuickName');
                const btn = document.getElementById('pddQuickCreateBtn');
                const name = nameInput ? nameInput.value.trim() : '';

                if (!name) {
                    nameInput.style.borderColor = '#e74c3c';
                    nameInput.placeholder = 'Entrez un nom !';
                    return;
                }

                btn.disabled = true;
                btn.textContent = 'Cr√©ation...';

                try {
                    const res = await fetch('http://127.0.0.1:8000/playlists', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: name,
                            description: '',
                            user_id: userId,
                            track_ids: [parseInt(trackId)]
                        })
                    });
                    const data = await res.json();

                    if (res.ok) {
                        document.getElementById('popupPlaylistDropdown').classList.remove('visible');
                        popupShowNotif('‚úÖ Playlist ¬´ ' + name + ' ¬ª cr√©√©e avec la musique !', 'success');
                        // Retirer la carte et la remplacer
                        popupRemoveAndReplace(parseInt(trackId));
                    } else {
                        popupShowNotif('Erreur : ' + (data.detail || 'cr√©ation √©chou√©e'), 'error');
                        btn.disabled = false;
                        btn.textContent = '‚ú® Cr√©er et ajouter';
                    }
                } catch (err) {
                    console.error('Erreur cr√©ation playlist:', err);
                    popupShowNotif('Erreur lors de la cr√©ation', 'error');
                    btn.disabled = false;
                    btn.textContent = '‚ú® Cr√©er et ajouter';
                }
            }

            // Mini notification dans la popup
            function popupShowNotif(message, type) {
                const existing = document.querySelector('.popup-notif');
                if (existing) existing.remove();

                const notif = document.createElement('div');
                notif.className = 'popup-notif';
                notif.textContent = message;
                notif.style.cssText = `
                    position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
                    background: ${type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#3498db'};
                    color: white; padding: 12px 28px; border-radius: 10px; font-size: 14px;
                    font-weight: 500; font-family: 'Outfit', sans-serif; z-index: 10002;
                    box-shadow: 0 6px 20px rgba(0,0,0,0.25);
                    animation: popupNotifIn 2.8s ease forwards;
                `;
                document.body.appendChild(notif);
                setTimeout(() => notif.remove(), 3000);
            }

            // √âchapper le HTML
            function escapeHtmlPopup(str) {
                if (!str) return '';
                return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
            }

        })();

        // Affichage des albums
        document.addEventListener("DOMContentLoaded", function () {
            fetch("http://127.0.0.1:8000/albums?limit=8")
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById("albums-container");
                    data.results.forEach(album => {
                        const albumCard = document.createElement("div");
                        albumCard.classList.add("album-card");
                        let filename = null;
                        if (album.album_image_file) {
                            const match = album.album_image_file.match(/([^/]+\.(jpg|png|jpeg))$/i);
                            filename = match ? match[1] : album.album_image_file;
                        }
                        let imageUrl = "images/no_image_album.png";
                        if (filename) {
                            imageUrl = "https://freemusicarchive.org/image/?file=images%2Falbums%2F" + filename + "&width=290&height=290&type=album";
                        }
                        const artistName = album.artists ? album.artists.split(",")[0].trim() : "Artiste inconnu";
                        albumCard.innerHTML = `
                            <img src="${imageUrl}" alt="${album.album_title}" class="album-cover" onerror="this.src='images/no_image_album.png'">
                            <div class="album-info">
                                <h3>${album.album_title}</h3>
                                <p>${artistName}</p>
                            </div>
                        `;
                        container.appendChild(albumCard);
                    });
                })
                .catch(error => {
                    console.error("Erreur lors du chargement des albums :", error);
                });
        });

        // Affichage des recommandations de tracks
        document.addEventListener("DOMContentLoaded", function () {
            // R√©cup√©rer l'ID utilisateur depuis le localStorage
            const userId = localStorage.getItem("userId");
            if (userId) {
                // Aller chercher les pr√©f√©rences de l'utilisateur
                fetch(`http://127.0.0.1:8000/voir_favorite/${userId}`)
                    .then(response => response.json())
                    .then(prefData => {
                        let trackIds = [];
                        if (prefData.count > 0 && prefData.results[0].ids_tracks) {
                            trackIds = prefData.results[0].ids_tracks.split(',').filter(x => x);
                        }
                        // Si pas de pr√©f√©rences, fallback sur une valeur par d√©faut
                        if (trackIds.length === 0) trackIds = [81466];
                        fetch(`http://127.0.0.1:8000/reco/tracks?` + trackIds.map(id => `track_ids=${id}`).join('&'))
                            .then(response => response.json())
                            .then(async data => {
                                const container = document.getElementById("tracks-container");
                                container.innerHTML = "";
                                const ids = data.results.map(t => t.track_id);
                                const trackRequests = ids.map(id =>
                                    fetch(`http://127.0.0.1:8000/tracks/${id}`)
                                        .then(res => res.json())
                                );
                                const tracksFullData = await Promise.all(trackRequests);
                                tracksFullData.forEach(track => {
                                    let filename = null;
                                    if (track.track_image_file) {
                                        const match = track.track_image_file.match(/([^/]+\.(jpg|png|jpeg))$/i);
                                        filename = match ? match[1] : track.track_image_file;
                                    }
                                    let imageUrl = "images/no_image_music.png";
                                    if (filename) {
                                        imageUrl = "https://freemusicarchive.org/image/?file=images%2Falbums%2F" + filename + "&width=290&height=290&type=album";
                                    }
                                    const trackCard = document.createElement("div");
                                    trackCard.classList.add("track-card");
                                    trackCard.innerHTML = `
                                        <img src="${imageUrl}" alt="${track.track_title}" class="track-cover" onerror="this.src='images/no_image_music.png'">
                                        <div class="track-info">
                                            <h3>${track.track_title}</h3>
                                            <p>${track.artist_names?.split(",")[0] || "Artiste inconnu"}</p>
                                        </div>
                                    `;
                                    trackCard.dataset.trackId = track.track_id;
                                    container.appendChild(trackCard);
                                });
                            })
                            .catch(error => {
                                console.error("Erreur lors du chargement des recommandations de tracks :", error);
                            });
                    })
                    .catch(error => {
                        console.error("Erreur lors de la r√©cup√©ration des pr√©f√©rences utilisateur :", error);
                    });
            } else {
                // Utilisateur non connect√© : fallback sur une valeur par d√©faut
                fetch("http://127.0.0.1:8000/reco/tracks?track_ids=81466")
                    .then(response => response.json())
                    .then(async data => {
                        const container = document.getElementById("tracks-container");
                        container.innerHTML = "";
                        const trackIds = data.results.map(t => t.track_id);
                        const trackRequests = trackIds.map(id =>
                            fetch(`http://127.0.0.1:8000/tracks/${id}`)
                                .then(res => res.json())
                        );
                        const tracksFullData = await Promise.all(trackRequests);
                        tracksFullData.forEach(track => {
                            let filename = null;
                            if (track.track_image_file) {
                                const match = track.track_image_file.match(/([^/]+\.(jpg|png|jpeg))$/i);
                                filename = match ? match[1] : track.track_image_file;
                            }
                            let imageUrl = "images/no_image_music.png";
                            if (filename) {
                                imageUrl = "https://freemusicarchive.org/image/?file=images%2Falbums%2F" + filename + "&width=290&height=290&type=album";
                            }
                            const trackCard = document.createElement("div");
                            trackCard.classList.add("track-card");
                            trackCard.innerHTML = `
                                <img src="${imageUrl}" alt="${track.track_title}" class="track-cover" onerror="this.src='images/no_image_music.png'">
                                <div class="track-info">
                                    <h3>${track.track_title}</h3>
                                    <p>${track.artist_names?.split(",")[0] || "Artiste inconnu"}</p>
                                </div>
                            `;
                            trackCard.dataset.trackId = track.track_id;
                            container.appendChild(trackCard);
                        });
                    })
                    .catch(error => {
                        console.error("Erreur lors du chargement des recommandations de tracks :", error);
                    });
            }
        });

        // Affichage des recommandations d'artistes
        document.addEventListener("DOMContentLoaded", function () {
            const userId = localStorage.getItem("userId");
            if (userId) {
                fetch(`http://127.0.0.1:8000/voir_favorite/${userId}`)
                    .then(response => response.json())
                    .then(prefData => {
                        let artistIds = [];
                        if (prefData.count > 0 && prefData.results[0].ids_artists) {
                            artistIds = prefData.results[0].ids_artists.split(',').filter(x => x);
                        }
                        if (artistIds.length === 0) artistIds = [1];
                        fetch(`http://127.0.0.1:8000/reco/artists?` + artistIds.map(id => `artist_ids=${id}`).join('&'))
                            .then(response => response.json())
                            .then(async data => {
                                const container = document.getElementById("artists-container");
                                container.innerHTML = "";
                                const ids = data.results.map(a => a.artist_id);
                                const artistRequests = ids.map(id =>
                                    fetch(`http://127.0.0.1:8000/artists/${id}`)
                                        .then(res => res.json())
                                );
                                const artistsFullData = await Promise.all(artistRequests);
                                artistsFullData.forEach(artist => {
                                    let filename = null;
                                    if (artist.artist_image_file) {
                                        const match = artist.artist_image_file.match(/([^/]+\.(jpg|png|jpeg))$/i);
                                        filename = match ? match[1] : artist.artist_image_file;
                                    }
                                    let imageUrl = "images/no_image_artist.png";
                                    if (filename) {
                                        imageUrl = "https://freemusicarchive.org/image/?file=images%2Fartists%2F" + filename  + "&width=290&height=290&type=artist";
                                    }
                                    const artistCard = document.createElement("div");
                                    artistCard.classList.add("artist-card");
                                    artistCard.innerHTML = `
                                        <img src="${imageUrl}" 
                                            alt="${artist.artist_name}" 
                                            class="artist-cover"
                                            onerror="this.src='images/no_image_artist.png'">
                                        <h3>${artist.artist_name}</h3>
                                        <p>Artiste</p>
                                    `;
                                    container.appendChild(artistCard);
                                });
                            })
                            .catch(error => {
                                console.error("Erreur lors du chargement des recommandations d'artistes :", error);
                            });
                    })
                    .catch(error => {
                        console.error("Erreur lors de la r√©cup√©ration des pr√©f√©rences utilisateur :", error);
                    });
            } else {
                fetch("http://127.0.0.1:8000/reco/artists?artist_ids=1")
                    .then(response => response.json())
                    .then(async data => {
                        const container = document.getElementById("artists-container");
                        container.innerHTML = "";
                        const artistIds = data.results.map(a => a.artist_id);
                        const artistRequests = artistIds.map(id =>
                            fetch(`http://127.0.0.1:8000/artists/${id}`)
                                .then(res => res.json())
                        );
                        const artistsFullData = await Promise.all(artistRequests);
                        artistsFullData.forEach(artist => {
                            let filename = null;
                            if (artist.artist_image_file) {
                                const match = artist.artist_image_file.match(/([^/]+\.(jpg|png|jpeg))$/i);
                                filename = match ? match[1] : artist.artist_image_file;
                            }
                            let imageUrl = "images/no_image_artist.png";
                            if (filename) {
                                imageUrl = "https://freemusicarchive.org/image/?file=images%2Fartists%2F" + filename  + "&width=290&height=290&type=artist";
                            }
                            const artistCard = document.createElement("div");
                            artistCard.classList.add("artist-card");
                            artistCard.innerHTML = `
                                <img src="${imageUrl}" 
                                    alt="${artist.artist_name}" 
                                    class="artist-cover"
                                    onerror="this.src='images/no_image_artist.png'">
                                <h3>${artist.artist_name}</h3>
                                <p>Artiste</p>
                            `;
                            container.appendChild(artistCard);
                        });
                    })
                    .catch(error => {
                        console.error("Erreur lors du chargement des recommandations d'artistes :", error);
                    });
            }
        });

        const goConnexion = document.getElementById("goConnexion");

    goConnexion.addEventListener("click", () => {
      window.location.href = "connexion.html"; // redirige vers la page unique login/register
    });

    // Fonction pour r√©cup√©rer les donn√©es du dashboard
    async function getDashboard() {
        try {
            const res = await fetch("http://localhost:3000/dashboard", {
            method: "GET",
            credentials: "include"
            });

            const data = await res.json();

            if (data.error) {
            document.getElementById("welcome").textContent = "Non connect√©, veuillez revenir √† la page login.";
            } else {
                document.getElementById("welcome").textContent = `Bienvenue ${data.user.user_firstname} !`;
            }

        } catch (err) {
            console.error(err);
            document.getElementById("welcome").textContent = "Erreur serveur";
        }
    }
    getDashboard();

    <!-- Confetti CDN -->
        src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js">

        // On attend que la page soit charg√©e
        document.addEventListener("DOMContentLoaded", function() {

            const popup = document.getElementById("avisPopup");
            let avisDejaAffichee = false;

            // On cache la popup au chargement
            popup.style.display = "none";

            // D√©tection sortie souris vers le haut (exit intent)
            document.addEventListener("mouseleave", function(e) {
                if (e.clientY <= 0 && !avisDejaAffichee) {
                    popup.style.display = "flex";
                    avisDejaAffichee = true;
                }
            });

            // Bouton OUI
            window.avisLike = function() {
                confetti({
                    particleCount: 200,
                    spread: 100
                });

                popup.style.display = "none";
            }

            // Bouton NON
            window.avisDislike = function() {
                popup.style.display = "none";

                const message = document.createElement("div");
                message.classList.add("avis-message");
                message.textContent = "Bah vtnm fdp";

                document.body.appendChild(message);

                setTimeout(() => {
                    message.remove();
                }, 4000);
            }

        });

  </script>

</body>
</html>